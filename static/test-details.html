<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script src="../../static/lib/functional.js"></script>
    <script src="../../static/lib/to-function.js"></script>
    <script src="../../static/lib/js-class.js"></script>
    <script src="../../static/lib/excanvas.js"></script>
    <script src="../../static/lib/bluff-src.js"></script>
    <style>
        .removed {
            text-decoration: line-through
        }
        .fail {
            color: red;
        }
        .pass {
            color: green;
        }
    </style>
    <script>
    Functional.install()
    String.prototype.supplant = function (o) {
        return this.replace(/\$(\w*)/g, function (a, b) {
                var v = o[b];
                if (v !== undefined) return v
                else throw "no value for " + b;
        });
    };
    function removeResult(linkNode, rev, duration) {
        $.post('remove', {revision: rev, duration: duration}, function() {
            $(linkNode).parent().addClass('removed');
            $(linkNode).replaceWith("");
        });
    }
    function sparseRevisionLabels(revisions) {
        var labels = {}
        var lastSeenRevision = "boo"
        $.each(revisions, function(i, rev) {
            if (rev !== lastSeenRevision) {
                labels[i] = rev;
                lastSeenRevision = rev;
            }
        });
        return labels;
    }
    function drawGraph(durations, revisions, best) {
        var g = new Bluff.Line('graph', 700);
        g.theme_keynote();
        g.title = 'timings';
        g.hide_legend = true;
        g.baseline_value = best * 1.125
        g.data('this test', durations);
        g.labels = sparseRevisionLabels(revisions)
        g.draw();
    }
    $(document).ready(function() {
        $.getJSON('json', function(data) {
            var bestResult = data[0];
            var results = data[1];
            var durations = map(function(res){return res[1];}, results);
            var revisions = map(function(res){return res[0];}, results)
            drawGraph(durations.reverse(), revisions.reverse(), bestResult);
            var lis = map(
                function(result) {
                    var passed = result[2];
                    return '<li class="$klass">revision: $rev, duration: $duration \
                        <a href="#" style="text-decoration: none" onclick="removeResult(this, \'$rev\', $duration)">(-)</a></li>'
                        .supplant({rev: result[0], duration: result[1], klass: passed && 'pass' || 'fail'});
                },
                results
            );
            $('#results').append(lis.join(''));
        });
    });
    </script>
</head>
<body>
    <canvas id='graph'></canvas>

    <h4>Test Results, newest first</h4>

    <ul id='results'>
    </ul>
</body>
</html>
